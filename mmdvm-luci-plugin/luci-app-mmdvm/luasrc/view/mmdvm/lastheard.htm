<%#
Copyright 2019 BD7MQB (bd7mqb@qq.com)
This is free software, licensed under the GNU GENERAL PUBLIC LICENSE, Version 2
-%>
<table border="0">
    <tr>
        <th align="left" width="200px"><div class="macrosectiontext"><a href="<%=luci.dispatcher.build_url("mmdvm", "livedisplay")%>" class="item-content item-link">Live Caller</a></div></th>
        <th align="right" width="200px">
        <% 
        local lh = lastheard[1]
        local callsign = lh.callsign
        if string.find(callsign, "/") then
            callsign = string.sub(callsign, 1, string.find(callsign, "/")-1)
        elseif string.find(callsign, "-") then
        callsign = string.sub(callsign, 1, string.find(callsign, "-")-1)
        end

        -- lh.name = luci.util.exec("grep -w %s /etc/mmdvm/DMRIds.dat | awk '{print $3, $4}'| head -1" % {lh.callsign})
        if string.find(lh.mode, "DMR") then
            local tg = tonumber(string.sub(lh.target, 4))
            if tg > 90 then
        %>
            <div class="macrosectiontext"><a href="https://hose.brandmeister.network/<%=tg%>" target="_blank" class="link external"><i class="f7-icons">volume</i></a></div>
        <% 
            end
        end 
        %>
        </th>
        </tr>
    <tr>
        <td class="lh_detail_callsign">
            <p class="callsign"><%=callsign%></p>
        </td>
        <td class="lh_detail_callsign">
            <p>Name: Unknown Who</p>
            <p>City: Somewhere</p>
            <p>Country: Nowhere</p>
        </td>
        </tr>
    <tr>
        <td class="lh_detail">
            <p>Source: <%=lh.source%></p>
            <p><%=lh.mode%> - <%=lh.target%></p>
        </td>
        <td class="lh_detail">
        <p>
        <% if lh.duration then %>
        Duration: <%=lh.duration%>s<br />
        Loss: <%="%0.1f" % {lh.loss} %>% &nbsp;&nbsp; BER: <%="%0.1f" % {lh.ber}%>%
        <% else %>
        <span>Transmiting ...</span>
        <% end %>
        </p>
        </td>
    </tr>
</table>
<h2><%:Gateway Activity%></h2>
<div id="lh">
<% luci.template.render("mmdvm/lh", {lastheard = lastheard} ) %>
</div>

<h2><%:Local RF%></h2>
<div id="localtx">
<% luci.template.render("mmdvm/lh", {lastheard = lastheard, localtx = 1} ) %>
</div>